# 第二章 Amazon 简单文件存储（Amazon S3) 和Amazon Glacier存储

** 《AWS认证解决方案架构师-联合考试》中的本章节包括不限于如下内容：**

## 第一点 设计高可用，经济高效，零容错，可扩展的系统

### 找出和识别云架构考虑因素，例如：基础组件和有效性设计

**包括如下内容：**
```
  * 怎么设计云服务
  * 计划和设计
  * 监控和日志
  * 需要熟悉如下内容：
    * AWS架构最佳实践
    * 根据客户规范进行开发，包括定价/成本（例如，按需，保留，现货；恢复时间目标[RTO]和恢复点目标[RPO]灾难恢复设计）
  * 架构权衡决策（例如，高可用性与成本） 
  * 混合IT架构
  * 弹性和可扩展性
```

## 第二点 实现与部署

### 确定使用Amazon简单存储服务（Amazon S3）编写和实现云解决方案的适当技术和方法
**包括如下内容：**
```
  * 配置服务以支持云中的法规遵从性要求
  * 在AWS全球基础设施上发布实例
  * 配置AWS标识和访问管理（IAM）策略和最佳实践
```

## 第三点 数据安全

### 认识并实施安全实践以实现最佳的云部署和维护
**包括如下内容：**
```
  * AWS 安全体系结构：
    * "核心" Amazon S3安全功能集
    * 加密解决方案（如密钥服务）
    * 复杂的访问控制（构建复杂的安全组、访问控制列表[ACL]等） 
```

## 简介

* 本章旨在让您基本了解AWS上提供的核心对象存储服务：Amazon简单存储服务（Amazon S3）和Amazon Glacier。Amazon S3为开发人员和IT团队提供安全、持久和高度可扩展的云存储。Amazon S3是一种易于使用的对象存储，具有简单的Web服务界面，您可以使用该界面从Web上的任何位置存储和检索任何数量的数据。Amazon S3还允许您只为实际使用的存储付费，它消除了与传统存储相关的容量规划和容量限制。

* Amazon S3是AWS引入的第一个服务之一，它是基本的Web服务之一，几乎所有在AWS中运行的应用程序都直接或间接使用Amazon S3。Amazon S3可以单独使用或与其他AWS服务结合使用，它提供了与许多其他AWS云服务高度集成的服务。例如，Amazon S3作为Amazon Kinesis和Amazon Elastic MapReduce（Amazon EMR）的持久目标存储，用作Amazon Elastic Block Store（Amazon EBS）和Amazon Relational Database Service（Amazon RDS）快照的存储，它被用作Amazon RealStand和Amazon DynDoDB的数据分级或加载存储机制，在许多其他功能中。因为Amazon S3是如此灵活、高度集成和通常使用的，所以要详细理解该服务是很重要的。

* Amazon S3存储的常见常见包括：
```
  * 备份或者归档本地或者云上的数据
  * 内容、媒体和软件存储和分发
  * 大数据分析
  * 静态网站托管
  * 云本地移动和互联网应用程序托管
  * 灾难恢复
```

* 为了支持这些用例和更多的用例，Amazon S3提供了一系列为各种通用用例设计的**存储类**：通用、不经常访问和存档。为了帮助管理数据的整个生命周期，Amazon S3提供了可配置的生命周期策略。通过使用生命周期策略，您可以让数据自动迁移到最合适的存储类，而无需修改应用程序代码。

* Amazon Glacier是与Amazon S3相关的另一种云存储服务，但它以极低的成本为数据存档和长期备份进行了优化。Amazon Glacier适用于冷数据，这是很少被访问的数据，检索时间为3到5小时是可以接受的。Amazon Glacier可以同时用作Amazon S3的存储类（请参阅Amazon S3高级功能部分中的存储类和对象生命周期管理主题），作为一个独立的档案存储服务（见亚马逊冰川部分）。 

## 对象存储与传统的块和文件存储对比

* 在传统的IT环境中，主要有两种存储方式：块存储和文件存储。块存储在较低的原始存储设备级别运行，并将数据作为一组编号进行管理，固定大小的块。文件存储在操作系统级别的更高级别上运行，并将数据作为文件和文件夹的命名层次结构进行管理。块和文件存储通常通过网络以存储区域网络（SAN）的形式进行访问，用于块存储，使用的协议包括iscsi或光纤通道，或作为网络连接存储（NAS）文件服务器或文件存储"文件管理器"，使用诸如：通用Internet文件系统（CIFS）或网络文件系统（NFS）等协议。无论是直接连接还是网络连接、块或文件，此类存储都与使用存储的服务器和操作系统密切相关。

* Amazon S3对象存储是完全不同的，Amazon S3是云对象存储。Amazon S3存储不与服务器紧密关联，而是独立于服务器并通过Internet访问。数据不是使用SCSI、CIFS或NFS协议作为块或文件进行管理，而是使用基于标准HTTP谓词的应用程序接口（API）作为对象进行管理。

* 每个Amazon S3对象都包含数据和元数据。对象位于名为bucket的容器中，每个对象由唯一的用户指定密钥（filename）标识。bucket是一个简单的平面文件夹，没有文件系统层次结构。也就是说，可以有多个bucket，但是在一个bucket中不能有子bucket，每个bucket可以容纳无限数量的对象。

* 很容易将 Amazon S3对象（或对象的数据部分）看作一个文件，将密钥看作文件名。但是，要记住Amazon S3不是一个传统的文件系统，并且在很大程度上是不同的。在Amazon S3中，您可以获取一个对象或放置一个对象，同时对整个对象进行操作，而不是像对文件那样增量地更新对象的一部分。

* 不同于文件系统，Amazon S3是一种高度持久和高度可扩展的对象存储，它是为读取而优化的，并且是用一个故意最小化的特性集构建的。它为文件存储提供了一个简单而健壮的抽象，使您摆脱了在传统存储中通常必须处理的许多底层细节。例如，使用Amazon S3您不必担心设备或文件系统的存储限制和容量规划―单个存储桶可以存储无限数量的文件。您也不必担心数据的持久性或跨可用性区域的复制Amazon S3对象是自动的在一个Region内的多个设施中的多个设备上进行复制。与可伸缩性相同，如果您的请求率稳步增长，Amazon S3会自动分区bucket，以支持非常高的请求率和许多客户端的同时访问。

* 备注
```
  如果除了Amazon S3存储之外，还需要传统的块或文件存储，AWS 提供了选项。Amazon EBS服务为Amazon Elastic Compute Cloud（amazon EC2）实例提供块级存储。Amazon Elastic File System（Aws EFS）使用NFS v4协议提供网络连接共享文件存储（NAS存储）。 
```

## Amazon 简单存储服务（Amazon S3）基础

* 现在您已经了解了传统块和文件存储与云对象存储之间的一些关键区别，我们可以更详细地探讨amazon s3的基础知识。

## 桶（Bucket）

* bucket是存储在Amazon S3中的对象（文件）的容器（web文件夹）。每个Amazon S3对象都包含在bucket中。bucket构成Amazon S3的顶级命名空间，bucket名称是全局的。这意味着你的bucket名称必须在所有AWS帐户中是唯一的，就像域名系统（DNS）域名一样，不只是在您自己的帐户中。存储桶名称最多可以包含63个小写字母、数字、连字符和periods。您可以创建和使用多个存储桶；默认情况下，每个帐户最多可以有100个。

* 备注
```
 最好使用包含您的域名并符合DNS名称规则的存储桶名称。这样可以确保您的存储桶名称是您自己的，可以在所有区域使用，并且可以承载静态网站。
```

### AWS Regions

* 尽管Amazon S3 bucket的名称空间是全局的，但是每个Amazon S3 bucket都是在您选择的特定区域中创建的，这允许您控制数据的存储位置。
* 您可以创建和使用位于特定终端用户或客户集附近的存储桶，以最小化延迟
* 或者位于特定区域以满足数据位置和主权问题
* 或者位于远离主要设施的位置，以满足灾难恢复和法规遵从性需求

* 您可以控制数据的位置；Amazon S3存储桶中的数据存储在该区域中，除非您显式地将其复制到位于不同区域的另一个存储桶中。

### Objects

* 对象是存储在Amazon S3存储桶中的实体或文件。一个对象可以以任何格式存储几乎任何类型的数据。对象的大小可以从0字节到5tb，单个存储桶可以存储无限数量的对象。这意味着Amazon S3可以存储几乎无限数量的数据。

* 每个对象都由数据（文件本身）和元数据（关于文件的数据）组成。Amazon S3对象的数据部分对Amazon S3来说是不透明的。这意味着对象的数据被简单地看作是Amazon S3不知道或不关心您存储的数据类型的字节流，对于文本数据和二进制数据，该服务的作用并不不同。

* 与Amazon S3对象相关联的元数据是一组描述该对象的名称/值对。有两种类型的元数据：系统元数据和用户元数据。系统元数据由Amazon S3自己创建和使用，它包括最近修改的日期、对象大小、md5摘要，和http的Content-Type。用户元数据是可选的，只能在创建对象时指定。可以使用自定义元数据为数据添加对您有意义的属性。

### Keys

* 存储在s3存储桶中的每个对象都由一个称为密钥的唯一标识符标识。您可以将密钥视为文件名。一个密钥最多可以包含1024字节的unicode utf-8字符，包括嵌入的斜杠、反斜杠、点和破折号。

* 键在单个bucket中必须是唯一的，但是不同的bucket可以包含具有相同键的对象。 

### Object URL

Amazon S3是internet的存储，每个amazons3对象都可以通过使用web服务端点、bucket名称和对象密钥形成的唯一url来寻址。例如，url:http://mybucket.s3.amazonaws.com/jack.doc mybucket是S3 Bucket名称，jack.doc是密钥或文件名。如果创建了另一个对象，例如：http://mybucket.s3.amazonaws.com/fee/fi/fo/fum/jack.doc，那么bucket名称仍然是mybucket，但现在键或文件名是字符串fee/fi/fo/fum/jack.doc，键可以包含斜杠或反斜杠等分隔符，帮助您命名和逻辑组织Amazon S3对象，但对于Amazon S3来说，它只是一个扁平名称空间中的长键名，没有实际的文件和文件夹层次结构，更多信息请参见后面"Amazon S3高级特性"部分的主题"前缀和分隔符"。
	
* 备注
```
 为了方便起见，Amazon S3控制台和前缀和分隔符特性允许您在Amazon S3存储桶中导航，就像有一个文件夹层次结构一样。但是，请记住，bucket是没有结构的键的单一平面命名空间。
```

### Amazon S3 操作

Amazon S3 API故意很简单，只有几个常见的操作，包括：
* 创建/删除bucket
* 写对象
* 读对象
* 删除对象
* bucket中的keys列表

### REST 接口

* Amazon S3的本机接口是一个REST（表示状态传输）API。使用REST接口，您可以使用标准http或https请求来创建和删除bucket、KEYS列表以及读写对象。REST将标准http"verbs"（http方法）映射到常见的crud（create，read，update，delete）操作。create是http put（有时post）；read是http get；delete是http delete；update是http post（有时put）。

备注：
```
  始终对Amazon S3 api请求使用https，以确保您的请求和数据是安全的 
```
* 在大多数情况下，用户不直接使用REST接口，而是使用可用的高级接口来与Amazon S3进行交互。这些包括AWS软件开发工具包（SDKS）（包装库），用于IOS、Android、JavaScript、Java、.NET、Node.js、PHP、Python、Ruby、Go和C++，AWS命令行接口（CLI），以及AWS管理控制台

备注：
```
  Amazon S3最初除了REST API之外还支持SOAP（简单对象访问协议）API，但是您应该使用REST API, 遗留的https端点仍然可用，但不支持新功能.
```

### 持久性和高可用

* 数据持久性和可用性是相关的，但概念略有不同。持久性解决了一个问题："我的数据将来还会存在吗？", 可用性解决了这个问题，"我现在可以访问我的数据吗？",AmazonS3旨在为您的数据提供非常高的耐用性和可用性。

* AmazonS3标准存储是为99.999999999%的持久性和99.99%的对象可用性而设计的，例如，如果使用AmazonS3存储10000个对象，则平均每10000000年会损失一个对象。Amazon S3通过在一个区域内的多个设施中的多个设备上自动冗余地存储数据，从而实现了高耐久性。它旨在在不丢失用户数据的情况下，维持两个设施中数据的并发丢失。Amazon S3提供了一个专为关键任务和主要数据存储而设计的高耐久性存储基础设施。

* 如果您需要存储不需要如此高级别持久性的非关键或易于复制的派生数据（如图像缩略图），则可以选择以较低的成本使用减少冗余存储（RRS）。RRS提供99.99%的持久性，存储成本低于传统的Amazon S3存储

* 备注
```
  尽管Amazon S3存储在基础设施级别提供了非常高的持久性，但通过使用其他功能（如版本控制、跨区域复制和MFA删除）来防止用户级意外删除或覆盖数据仍然是一种最佳实践。

```

### 数据一致性
* Amazon S3是一个最终保持一致的系统。因为您的数据会自动复制到一个区域内的多个服务器和位置，所以数据中的更改可能需要一些时间才能传播到所有位置。因此，在某些情况下，您在更新后立即读取的信息可能会返回过时的数据。

* 对于新对象的PUTS，在这种情况下，这不是一个问题，Amazon S3提供了读写一致性。但是，对于现有对象（对象覆盖到现有密钥）和对象删除，Amazon S3提供了最终的一致性。

* 如果将新数据放入现有的密钥中，则后续的GET可能返回旧的数据。同样，如果删除一个对象，该对象的后续获取可能仍然读取被删除的对象。在所有情况下，对单个密钥的更新都是原子的，以便最终一致读取，将获得新数据或旧数据，但从来没有不一致的数据混合。

### 访问控制

* 默认情况下，Amazon S3是安全的；当您在Amazon S3中创建bucket或object时，只有您拥有访问权限。为了允许您对其他对象进行受控访问，Amazon S3提供了粗粒度访问控制（Amazon S3访问控制列表[ACL]）和细粒度访问控制（Amazon S3 bucket策略，AWS身份和访问管理[IAM]策略，以及查询字符串身份验证）。


* Amazon S3 ACL允许您授予某些粗粒度的权限：在对象或桶级上读、写或完全控制。ACL是在IAM存在之前创建的遗留访问控制机制。ACL现在被用于有限的用例集，例如，启用bucket日志记录或使承载静态网站的bucket具有world-readable。

Amazon S3 Bucket策略是Amazon S3推荐的访问控制机制，并提供更细粒度的控制。Amazon S3 Bucket策略与IAM策略非常相似，后者在第6章"AWS标识和访问管理（IAM）"中进行了讨论，但在以下方面有细微的不同：
```
  * 它们与bucket资源而不是IAM主体相关联。
  * 它们在策略中包含对IAM主体的显式引用。此主体可以与不同的AWS帐户关联，因此Amazon S3 Bucket策略允许您分配对Amazon S3资源的跨帐户访问。
```

* 使用Amazon S3 bucket策略，您可以指定谁可以访问bucket，从何处（通过无类域间路由[cidr]块或ip地址）访问bucket，以及在一天中的什么时间访问bucket。

* 最后，IAM策略可以直接与授予Amazon S3 bucket访问权限的IAM主体关联，就像它可以授予对任何AWS服务和资源的访问权限一样。显然，您只能将IAM策略分配给您控制的AWS帐户中的主体。



