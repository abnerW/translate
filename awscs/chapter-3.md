# 第三章 Amazon Elastic Computer Cloud(Amazon EC2) 和 Amazon Elastic Block Store(Amazon EBS)
**《AWS认证解决方案架构师-联合考试》中的本章节目标包括不限于如下内容：**

## 第一点 设计高可用、低成本、容错、可扩展的系统

### 找出和识别云架构考虑因素，例如：基础组件和有效性设计

**包括如下内容：**
```
  * 怎么设计云服务
  * 计划和设计
  * 监控和日志
```

## 第二点 实现/部署

### 使用Amazon Ec2、amazon Simple Storage Service（amazon S3）、aws Elastic Beanstalk、aws Cloudformation、aws Opsworks、amazon Virtual Private Cloud（amazon Vpc）和aws Identity And Access Management（iam）确定适当的技术和方法来编码和实现云解决方案。

**包含如下内容**
```
  * 配置一个Amazon Machine Image（AMI）
  * 配置服务以满足云上得合规性需求
  * 在AWS全球基础设施上发布实例

```

## 第三点 数据安全

### 认识到关键的灾难恢复技术及其实现
**包含如下内容**
```
  * 灾难恢复
  * Amazon EB
```


## 简介
在本章中，你将会学习Amazon Elastic Compute Cloud（Amazon EC2）和Amazon Elastic Block Store（Amazon EBS）如何提供基本的计算元素和块等级的存储，用以运行你在AWS上的workloads。对于考试来说，主要聚焦你需要理解的关键话题，包括如下内容：

* 实例类型和amazon机器映像（amis）如何定义在云上启动的实例的功能
* 如何安全地访问云上运行的实例
* 如何使用称为安全组的虚拟防火墙保护实例
* 如何让您的实例为无人参与启动配置自己
* 如何在云上监视和管理实例
* 如何改变现有实例的能力，支付选项可用于可负担性和灵活性的最佳组合
* 租赁选项和放置组如何提供选项以优化合规性和性能
* 实例存储与Amazon EBS卷有何不同以及它们何时有效
* 通过Amazon EBS提供哪些类型的卷
* 如何在amazon ebs上保护您的数据

## Amazon Elastic Compute Cloud(Amazon EC2)
Amazon EC2是AWS一个主要的web服务，在云上提供弹性调整计算的能力。

### 计算基础
* 计算是指完成工作量所需的计算能力。如果你的工作量很小，比如一个网站很少有访客，那么你的计算需求就很小。一个很大的工作量，比如针对一个常见的癌症目标筛选一千万种化合物，可能需要大量计算。您需要的计算量可能会随着时间的推移而急剧变化

* Amazon EC2允许您通过启动名为Instances的虚拟服务器来获取计算。当您启动一个实例时，您可以随心所欲地使用该计算，就像使用本地服务器一样。因为您要为实例的计算能力付费，当实例运行时，您将按小时收费。当您停止实例时，将不再收费。

* 在AWS上启动实例有两个关键概念：（1）专用于实例的虚拟硬件数量和（2）加载在实例上的软件，这两个维度的新实例分别由实例类型和AMI控制。

#### 实例类型
* 实例类型定义了支持amazon ec2实例的虚拟硬件。有几十种可用的实例类型，在以下维度中有所不同：
```
 * 虚拟CPUs（vCPUs）
 * 内存
 * 存储（大小和类型）
 * 网络性能
```

* 实例类型根据这些值之间的比率分组为多个系列。例如，M4系列提供了计算、内存和网络资源的平衡，对于许多应用程序来说，这是一个很好的选择。在每个系列中，都有几个在大小上呈线性放大的选择。图3.1显示了M4系列中的四个实例大小。请注意，vCPU与内存的比率随大小呈线性放大而保持不变。每个大小的每小时价格也呈线性放大。例如，一个m4.xlarge实例的成本是m4.large实例的两倍。
|---|---|---|
|类型|vCPUs|内存|
m4.large|2|8|
m4.xlarge|4|16|
m4.2xlarge|8|32|
m4.4xlarge|16|64|

图3.1 m4家族的实例内存和vCPUs 

备注：
```
 原文档为图，此处转换为表格。但仍叫做：图3.1
```

* 不同的实例类型族会调整比率以适应不同类型的工作负载，但它们都会在族中显示这种线性放大行为。表3.1列出了一些可用的族

**表3.1：实例类型族示例**
* 家族
|---|---|
|c4|计算型-针对需要大量处理的工作负载|
|r3|内存型-内存密集型工作负载|
|i2|存储型-需要大量快速SSD存储的工作负载|
|g2|基于GPU实例-用于图形和通用GPU计算工作负载|

* 为了响应客户需求并利用新的处理器技术，aws偶尔会引入新的实例系列。请查看aws网站上的当前列表。选择实例类型时要考虑的另一个变量是网络性能。对于大多数实例类型，aws发布了网络性能的相对度量：低、中或高。某些实例类型指定10 gbps的网络性能。随着实例类型的增长，族内的网络性能将提高。

* 对于需要更高网络性能的工作负载，许多实例类型支持增强的网络。增强的网络通过启用称为单根I/O虚拟化（SR-IOV）的功能减少了虚拟化对网络性能的影响。这会导致每秒包数（PPS）更多，延迟更低，在编写本文时，有一些实例类型支持C3、C4、D2、I2、M4中的增强型网络，和r3系列（请参阅aws文档以获取当前列表）。在实例上启用增强的网络包括确保安装了正确的驱动程序并修改实例属性。增强的网络仅适用于在amazon虚拟私有云（amazon vpc）中启动的实例，这在第4章中讨论过，“亚马逊虚拟私有云（Amazon VPC）。”

#### Amazon Machine Images（AMIs）
Amazon Machine Image（AMI）定义了实例启动是要在实例上运行的的初始化软件。AMI定义了实例启动时软件状态的各个方面，包括：
```
 * 操作系统以及其配置
 * 任何不定的初始化状态
 * 应用或者系统软件
```

* 所有的AMIs都是基于X86 OSs，无论是Linux还是Windows。
* AMIs有四个源：
```
  * 通过AWS发布
    AWS发布的AMIs有许多不同版本的操作系统，包括linux和windows；
    其中包括linux的多个发行版（包括ubuntu、red hat和Amazon自己的发行版）以及windows 2008和windows 2012。
    基于其中一个AMIs启动实例将导致默认的os设置，类似于从标准OS ISO映像安装OS。
  * AWS集市
    AWS marketplace是一个在线商店，它帮助客户查找、购买并立即开始使用运行在amazon ec2上的软件和服务。许多aws合作伙伴已经在aws marketplace上提供了他们的软件。这提供了两个好处：客户不需要安装软件，许可协议也适用于云计算，从aws marketplace ami启动的实例会产生实例类型的标准小时成本加上额外软件的每小时额外费用（一些开源aws marketplace包没有额外的软件费用）。
  * 由现有实例生成
    AMI可以从现有的Amazon EC2实例创建。
    这是AMIs的一个非常常见的来源。
    客户从发布的AMI启动一个实例，然后该实例被配置为满足所有客户的更新、管理、安全的企业标准，等等。
    然后从配置的实例生成一个AMI，并用于生成该OS的所有实例，这样，所有新实例都遵循公司标准，单个项目更难启动不一致的实例
  * 上传虚拟服务器
    使用aws vm导入/导出服务，客户可以从各种虚拟化格式创建映像，
    包括raw、vhd、vmdk和ova。
    支持的操作系统（Linux和Windows）的当前列表可以在AWS文档中找到。
    客户有责任遵守其操作系统供应商的许可条款。
```

### 安全地使用实例
* 一旦启动，实例就可以通过Internet进行管理。AWS有许多服务和特性来确保这种管理可以简单而安全地完成

#### 寻址实例
有几种方法可以在创建实例时通过Web寻址 
* 公共域名系统（DNS）名称
 当你启动一个实例时，aws创建可用于访问实例的dns名称。此dns名称是自动生成的，客户无法指定。可以在aws管理控制台的"描述"选项卡中或通过命令行界面（cli）或应用程序编程界面（api）找到此名称。此dns名称仅在实例正在运行，无法转移到其他实例

* 公共IP
 已启动的实例也可能分配了公用IP地址。此IP地址是从AWS保留的地址分配的，无法指定。此IP地址在Internet上是唯一的，仅在实例运行时持续存在，并且无法传输到其他实例。

* 弹性IP
 弹性IP地址是Internet上唯一的地址，您可以独立保留并与Amazon EC2实例关联。与公共IP类似，有一些关键的区别。这个IP地址会一直存在，直到客户释放它，并且不会绑定到单个实例的生存期或状态。因为在实例出现故障时，可以将它转移到替换实例，它是一个公共地址，可以在外部共享，而无需将客户端耦合到特定实例。

* 备注
```
 私有ip地址和弹性网络接口（enis）是amazon vpc上下文中可用的附加实例寻址方法，这些将在第4章中讨论。 
```

#### 初始化访问

* Amazon EC2使用公钥密码加密和解密登录信息。公钥密码使用公钥加密一段数据，并使用关联的私钥解密数据。这两个密钥一起称为密钥对。可以通过AWS管理控制台、CLI或API创建密钥对，或者客户可以上传自己的密钥对。aws存储公钥，而私钥由客户保存。私钥对于第一次获得对实例的安全访问至关重要。

* 备注
```
 安全地存储您的私钥。当Amazon EC2启动Linux实例时，公钥存储在实例上的/.ssh/authorized\u keys文件中，并创建一个初始用户。初始用户可能因操作系统而异。例如，Amazon Linux发行版的初始用户是ec2-user，对实例的初始访问是通过使用ec2-user和通过ssh登录的私钥获得的，此时可以配置其他用户并注册到LDAP等目录中。
```

* 在启动windows实例时，Amazon EC2 会为本地管理员帐户生成一个随机密码，并使用公钥对密码进行加密。对实例的初始访问是通过使用私钥解密密码获得的，在控制台中或通过API。解密后的密码可用于通过RDP使用本地管理员帐户登录到实例。此时，您可以创建其他本地用户和/或连接到活动目录域

* 备注
```
 最佳实践：修改初始的本地管理员密码。
```

#### 虚拟防火墙保护
* AWS允许您通过称为安全组的虚拟防火墙控制进出实例的流量。安全组允许您基于端口、协议、，和源/目标。安全组具有不同的功能，这取决于它们是与Amazon VPC还是Amazon EC2 classic相关联。表3.2比较了这些不同的功能（Amazon VPC在第4章中讨论） 

|---|---|
|安全组类型|能力|
|EC2-Classic安全组|控制实例外出流量|
|VPC安全组|控制进入和出去的流量|
表 3.2 不通的安全组
* 当实例启动时，安全组和实例向关联，每个实例必须至少有一个安全组，但也可以有多个。

* 安全组为默认拒绝，即不允许安全组规则未明确允许的任何通信。规则由表3.3中的三个属性定义。当一个实例与多个安全组关联时，规则是聚合的，并且允许每个组允许的所有流量。例如，如果安全组A允许72.58.0.0/16的RDP流量，而安全组B允许0.0.0.0/0的HTTP和HTTPS流量，并且您的实例与这两个组关联，然后rdp和http/s流量都将被允许进入您的实例。

|---|---|
|属性|含义|
|端口|受此规则影响的端口号。例如，用于http通信的端口80|
|协议|受此规则影响的通信量的通信标准|
|源/目的|标识通信的另一端，传入流量规则的源，或传出通信规则的目标。源/目标可以通过两种方式定义：CIDR阻止定义特定IP地址范围的X.X.X.X/X样式定义。安全组包括与给定安全组关联的任何实例。这有助于防止耦合安全组规则有特定的IP地址|
* 安全组是有状态的防火墙；也就是说，会记住传出消息，以便允许通过安全组进行响应，而不需要显式的入站规则。

* 安全组是在实例级别应用的，而不是传统的在外围保护的内部部署防火墙。这样做的效果是，攻击者不必为了访问安全组中的所有实例而破坏单个外围，而是必须为每个实例重复地破坏安全组。

### 实例的生命周期
* amazon ec2有几个特性和服务，可以在其整个生命周期中方便地管理Amazon EC2实例。

#### 启动
当启动一个新的Amazon EC2实例的时候，还有一些附加服务非常有用。

##### 引导（Bootstrapping）
* 云的一个巨大好处是能够以本地硬件不可能的方式编写虚拟硬件管理脚本。为了实现这一点，必须有一些方法来配置实例，并在启动实例时以编程方式安装应用程序。在启动时提供要在实例上运行的代码的过程称为引导。

* 启动实例时的参数之一是名为userdata的字符串值。此字符串将传递给操作系统，以便在实例首次启动时作为启动过程的一部分执行在linux实例上，这可以是shell脚本，在windows实例上，这可以是批处理样式脚本或powershell脚本。脚本可以执行以下任务：
```
 * 将修补程序和更新应用于操作系统
 * 注册目录服务
 * 安装应用软件
 * 从要在实例上运行的存储中复制较长的脚本或程序
 * 安装Chef或Puppet并为实例分配角色，以便配置管理软件可以配置实例
```

* 备注
```
 UserDAta 和实例一起存储的，且不加密，因此在UserData中不要包含任何机密是非常重要的（例如：密码和秘钥）。

```
##### VM导入/导出

* 除了将虚拟实例导入为AMIs之外，VM导入/导出使您可以轻松地将虚拟机（VM）从亚马逊的EC2实例从现有的环境导入，并将它们导出回您的Office环境。您只能导出以前导入的amazon ec2实例。无法导出从AMIS在AWS中启动的实例。    

##### 实例元数据

* 实例元数据是关于实例的数据，您可以使用这些数据来配置或管理正在运行的实例。这是唯一的，因为它是一种机制，可以从操作系统中获取实例的AWS属性，而无需调用AWS API对http://169.254.169.254/latest/meta-data/的http调用将返回实例元数据树的顶部节点。实例元数据包含多种属性，包括：
```
 * 关联的安全组
 * 实例ID
 * 实例类型
 * 用于启动实例的AMI
```
* 这只是开始触及元数据中可用信息的表面有关完整列表，请参阅AWS文档

#### 管理实例


#### 监控实例

#### 修改实例


#### 中断保护






















