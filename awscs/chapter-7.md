# 第七章 数据库和AWS
**《AWS认证解决方案架构师-联合考试》中的本章节目标包括不限于如下内容：**

## 第一点 设计高可用、低成本、容错、可扩展的系统

### 找出和识别云架构考虑因素，例如：基础组件和有效性设计

包含内容如下：

* 计划和设计
* 架构权衡决策（Amazon 关系数据库服务【Amazon RDS】 vs 在Amazon 弹性云计算上安装【Amazon EC2】)
* AWS 架构最佳实践
* RTO 和 RPO 灾难恢复设计
* 弹性和可扩展性

## 第三点 数据安全

### 认识并实施安全实践以实现最佳的云部署和维护

包含如下内容：

* AWS 管理和安全服务
* 设计模式

### 认识到关键的灾难恢复技术及其实现

本章包含数据库的基本概念，并介绍3种Amazon的托管数据库服务：
* Amazon Relational Database Service（Amazon RDS）
* Amazon DynamoDB
* Amazon Redshift
这些托管服务简化了关系数据库，Nosql数据库，数据仓库的安装和运维。

本章聚焦于在考试中你需要理解的关键点包括：

* 关系数据库，nosql数据库和数据仓库之间的不同；
* 在Amazon EC2上运行数据库和使用Amazon RDS各自的优点及权衡
* 怎么将数据库引擎部署到云上
* 怎么备份和恢复数据库，以满足你对RPO和RTO需要
* 怎么构建高可用的数据库架构
* 怎么垂直扩展你的数据库计算和存储资源
* 怎么选择合适的存储卷
* 怎么用读副本实现水平扩展
* 怎么设计和扩展Amazon DynamoDB表
* 如何对Amazon DynamoDB进行读写
* 如何使用二级索引加快查询速度
* 如何设计 Amazon Redshift 表
* 如何加载和查询Amazon Redshift 数据仓库
* 如何加固你的数据库，表和集群

## 数据库启蒙
* 几乎每个应用程序都依赖于一个数据库来为其用户存储重要的数据和记录。数据库引擎允许应用程序访问、管理和搜索大量数据记录。在架构良好的应用程序中，数据库将需要满足系统的性能需求、可用性需求和可恢复性特征。

* 数据库系统和引擎可以分为两大类：关系数据库管理系统（RDBMS）和NoSQL（或非关系）数据库。使用RDBMS和NoSQL数据库的组合构建应用程序并不少见。必须对基本的数据库概念、Amazon RDS和amazondynaminodb有很强的理解，才能通过这次考试

### 关系数据库
* 目前使用的最常见的数据库类型是关系数据库。关系数据库可以追溯到20世纪70年代，当时在IBM工作的Edgar F.Codd开发了关系模型的概念。如今，关系数据库为所有类型的应用程序提供了强大的功能，从社交媒体应用程序、电子商务网站和博客到复杂的企业应用程序。常用的关系数据库软件包包括MySQL、PostgreSQL、Microsoft SQL Server和Oracle。

* 关系数据库提供了一个公共接口，允许用户使用使用结构化查询语言（SQL）编写的命令或查询从数据库进行读写。关系数据库由一个或多个表组成，表由类似于电子表格的列和行组成。数据库列包含记录的特定属性，如姓名、地址和电话号码。每个属性都分配了一个数据类型，如text、number或date，数据库引擎将拒绝无效的输入。

* 一个数据库行包含一个单独的记录，例如一个上学的学生的详细信息。考虑表7.1中的例子。

* 表7.1 学生表
学生ID|姓|名|性别|年龄
---|---|---|---|---
1001|Joe|Dusty|M|29
1002|Andrea|Romanov|F|30
1003|Ben|Johnson|M|30
1004|Beth|Roberts|F|30

* 这是关系数据库中一个基本的表的例子。有5列，每列的数据类型也不同：
```
 * 学生ID： number integer
 * 姓：String
 * 名：String
 * 性别：String（长度为：1）
 * 年龄：Integer

```

* 这个示例表有四条记录，每条记录代表一个学生。每个学生都有一个StudentID字段，通常是每个学生的唯一数字。标识每个学生的唯一数字可以称为主键。

* 表中的一条记录可以通过引用记录的主键与另一个表中的记录相关联。此指针或引用称为外键。例如，记录每个学生成绩的成绩表将有自己的主键和一个称为外键的附加列，该列引用学生记录的主键。通过引用其他表的主键，关系数据库可以最大限度地减少关联表中的数据重复。对于关系数据库，需要注意的是，必须在将数据添加到表中之前定义表的结构（如列数和每列的数据类型）。

* 根据表的组织方式和应用程序使用关系数据库的方式，关系数据库可以分为联机事务处理（OLTP）或联机分析处理（OLAP）数据库系统。OLTP指的是经常写入和更改数据（例如，数据输入和电子商务）的面向事务的应用程序。OLAP通常是数据仓库的领域，指的是报告或分析大型数据集。大型应用程序通常同时具有OLTP和OLAP数据库。

* Amazon关系数据库服务（Amazon RDS）大大简化了OLTP和OLAP数据库的设置和维护。Amazon RDS支持六种流行的关系数据库引擎：MySQL、Oracle、PostgreSQL、Microsoft SQL Server、MariaDB和Amazon Aurora。您还可以选择使用Windows或Linux Amazon Elastic Compute Cloud（Amazon EC2）实例运行几乎任何数据库引擎，并自行管理安装和管理。

### 数据仓库
* 数据仓库是可以来自一个或多个源的数据的中央存储库。此数据存储库通常是一种特殊类型的关系数据库，可用于通过OLAP进行报告和分析。组织通常使用数据仓库来编译报告，并使用高度复杂的查询来搜索数据库。

* 与每秒可更新数千次的OLTP关系数据库相比，数据仓库通常每天或每小时按批处理计划更新多次。许多组织将关系数据库分成两个不同的数据库：一个数据库作为OLTP事务的主要生产数据库，另一个数据库作为OLAP的数据仓库。OLTP事务经常发生，而且相对简单。OLAP事务发生的频率要低得多，但要复杂得多。

* Amazon RDS通常用于OLTP工作负载，但也可以用于OLAP。Amazon Redshift是一个专门为OLAP用例设计的高性能数据仓库。在同一个应用程序中将Amazon RDS与Amazon Redshift结合起来，并定期提取最近的事务并将它们加载到报表数据库中也是很常见的。

### NoSql 数据库
* NoSQL数据库近年来获得了显著的普及，因为它们通常使用更简单、更灵活，并且可以实现与传统关系数据库很难或不可能的性能水平。传统的关系数据库很难在没有大量工程和成本的情况下扩展到单个服务器之外，但是NoSQL体系结构允许在商品硬件上进行水平扩展。

* NoSQL数据库是非关系数据库，并且没有关系数据库的相同表和列语义。NoSQL数据库通常是具有可随时间或变化而变化的灵活模式的键/值存储或文档存储。相比之下，关系数据库需要非常严格的模式。

* NoSQL体系结构的许多概念将其基础概念追溯到2006和2007出版的白皮书，描述了Amazon在Amazon的分布式系统。如今，许多应用程序团队使用Hbase、MongoDB、Cassandra、CouchDB、Riak和Amazon DynamoDB以高事务速率存储大量数据。这些数据库引擎中的许多都支持集群，并在许多机器上水平扩展，以提高性能和容错性。NoSQL的一个常见用例是管理用户会话状态、用户配置文件、购物车数据或时间序列数据。

* 您可以使用Amazon EC2在AWS上运行任何类型的NoSQL数据库，也可以选择amazon dynamodb这样的托管服务来处理构建跨多个数据中心的分布式集群的繁重工作

## Amazon关系数据库服务
* Amazon RDS是一种简化AWS上关系数据库的设置、操作和扩展的服务。使用Amazon RDS，您可以花更多的时间关注应用程序和模式，并让amazonrds卸载备份、修补、扩展和复制等常见任务。

* Amazon RDS帮助您简化数据库软件的安装以及基础设施容量的配置。在几分钟内，Amazon RDS可以启动许多流行的数据库引擎之一，这些引擎已经准备好开始执行SQL事务。在首次发布之后，Amazon RDS通过定期自动执行常见的管理任务来简化日常维护。

* 使用Amazon RDS，您可以加快开发进度，并为管理关系数据库建立一致的操作模型。例如，Amazon RDS可以轻松地复制您的数据，以提高可用性、提高耐用性，或者为读取繁重的数据库工作负载扩展或超出单个数据库实例。

* Amazon RDS公开了一个数据库端点，客户端软件可以连接并执行SQL。Amazon RDS不提供对数据库（DB）实例的shell访问，它限制对某些需要高级权限的系统过程和表的访问。使用Amazon RDS，您通常可以使用相同的工具来查询、分析、修改和管理数据库。例如，当前的Extract、Transform、Load（ETL）工具和报表工具可以用相同的驱动程序以相同的方式连接到Amazon RDS数据库，


### 数据库实例
* Amazon RDS服务本身提供了一个应用程序编程接口（API），允许您创建和管理一个或多个DB实例。DB实例是一个独立的数据库环境，部署在云中的私有网段中。每个数据库实例代表您运行和管理流行的商业或开源数据库引擎。Amazon RDS目前支持以下数据库引擎：MySQL、PostgreSQL、MariaDB、Oracle、SQL Server和Amazon Aurora。

* 可以通过调用CreateDBInstance API或使用AWS管理控制台来启动新的DB实例。现有的DB实例可以使用MuffFydBistAsAPI更改或调整大小。一个数据库实例可以包含多个不同的数据库，所有这些数据库都是通过使用Amazon RDS端点执行SQL命令在数据库实例本身中创建和管理的。可以使用今天使用的相同SQL客户机工具和应用程序创建、访问和管理不同的数据库。

* 数据库实例的计算和内存资源由其数据库实例类决定。您可以选择最符合计算和内存需求的DB实例类。数据库实例类的范围从具有1个虚拟CPU（vCPU）和1 GB内存的DB.t2.micro扩展到具有32个vCPU和244 GB内存的DB.r3.8XL。当您的需求随着时间的变化而变化时，您可以更改实例类和内存计算的平衡，Amazon RDS会将您的数据迁移到一个更大或更小的实例类中。独立于您选择的DB实例类，您还可以控制所用存储的大小和性能特征。

* Amazon RDS支持多种引擎、版本和功能组合。查看Amazon RDS文档以确定对特定功能的支持。使用DB参数组和DB选项组公开和管理许多功能和常见配置设置。DB参数组充当可应用于一个或多个DB实例的引擎配置值的容器。可以更改现有实例的DB参数组，但需要重新启动。DB选项组充当引擎功能的容器，默认情况下为空。为了启用数据库引擎的特定功能（例如，Oracle Statspack、Microsoft SQL Server Mirroring），需要创建一个新的数据库选项组并相应地配置设置。

* 备注

现有的数据库可以使用本地工具和技术，根据引擎而迁移到Amazon RDS。例如，对于MySQL，可以使用mysqldump导出备份并将文件导入Amazon RDS MySQL。您还可以使用AWS数据库迁移服务，它为您提供了一个图形界面，简化了模式和数据库之间数据的迁移。AWS数据库迁移服务还帮助将数据库从一个数据库引擎转换到另一个数据库引擎

### 操作好处
* Amazon RDS通过应用非常一致的部署和操作模型来提高数据库的操作可靠性。这一级别的一致性在一定程度上是通过限制可以对底层基础设施进行的更改类型和广泛使用自动化来实现的。例如，对于Amazon RDS，不能使用Secure Shell（SSH）登录到主机实例并安装自定义软件。但是，您可以使用SQL管理员工具进行连接，或者使用数据库选项组和数据库参数组更改数据库实例的行为或功能配置。如果您想要完全控制操作系统（OS），或者需要提升权限才能运行，那么可以考虑在Amazon EC2上安装数据库，而不是在Amazon RDS上。

* Amazon RDS旨在简化以可靠方式操作关系数据库所需的常见任务。在数据中心、Amazon EC2或Amazon RDS上操作关系数据库时，比较管理员的职责是很有用的（参见表7.2）

* 表7.2 操作责任对比

责任|裸机上运行数据库|Amazon EC2上运行数据库| Amazon RDS 数据库
---|---|---|---
App 优化|自己|自己|AWS
扩展|自己|自己|AWS
高可用|自己|自己|AWS
备份|自己|自己|AWS
DB引擎补丁|自己|自己|AWS
软件安装|自己|自己|AWS
OS补丁|自己|自己|AWS
OS安装|自己|AWS|AWS
服务器运维|自己|AWS|AWS
机架和堆栈|自己|AWS|AWS
电源和冷却|自己|AWS|AWS

### 数据库引擎

Amazon RDS支持6中数据库引擎：
* Mysql
* PostgreSQL
* MariaDB
* Oracle
* SQL Server
* Amazon Aurora

* 根据您选择的引擎，功能和功能略有不同。

#### Mysql
* MySQL是世界上最流行的开源数据库之一，它被用来为各种应用程序提供支持，从小型个人博客到世界上一些最大的网站。截至本文撰写时，Amazon RDS for MySQL目前支持MySQL 5.7、5.6、5.5和5.1。引擎正在运行开源社区版，InnoDB是默认和推荐的数据库存储引擎。Amazon RDS MySQL允许您使用标准的MySQL工具（如MySQL Workbench或SQL Workbench/J）进行连接。Amazon RDS MySQL支持多AZ部署以获得高可用性，并读取副本以实现水平扩展。


#### MariaDB
* Amazon RDS最近增加了对运行MariaDB的DB实例的支持。MariaDB是一个流行的开源数据库引擎，由MySQL的创建者构建，并通过企业工具和功能进行了增强。MariaDB添加了增强MySQL性能、可用性和可伸缩性的特性。截至本文撰写之时，AWS支持MariaDB版本10.0.17。Amazon RDS完全支持用于MariaDB实例的XtraDB存储引擎，并且像Amazon RDS MySQL和PostgreSQL一样，支持多AZ部署和读取副本。

### Oracle
* Oracle是企业中最流行的关系数据库之一，并且完全受Amazon RDS支持。截至撰写本文时，Amazon RDS支持运行Oracle 11g和Oracle 12c的多个版本的DB实例。Amazon RDS支持使用任何标准SQL客户端应用程序（如Oracle SQL Plus）访问DB实例上的架构。
* Amazon RDS Oracle支持流行数据库引擎的三个不同版本：标准版1、标准版和企业版。表7.3概述了不同版本之间的一些主要差异：

版本|性能|多可用区支持|加密
---|---|---|---
标准版-1|++++|YES|KMS
标准版|++++++++|YES|KMS
企业版|++++++++|YES|KMS和TDE

### Microsoft SQL Server
* Microsoft SQL Server是企业中另一个非常流行的关系数据库。Amazon RDS允许数据库管理员（dba）使用本地工具（如sqlservermanagementstudio）连接到云中的SQL Server DB实例。截至撰写本文时，Amazon RDS提供了对许多版本的Microsoft SQL Server的支持，包括SQL Server 2008 R2、SQL Server 2012和SQL Server 2014。

* Amazon RDS SQL Server还支持四个不同版本的SQL Server：Express Edition、Web Edition、Standard Edition和Enterprise Edition。表7.4突出显示了这些版本之间的相对性能、可用性和加密差异。

* 表7.4 Amazon RDS SQL 服务器版本对比
版本|性能|多可用区支持|加密
---|---|---|---
Express|+|No|KMS
Web|++++|No|KMS
Standard|++++|Yes|KMS
Enterprise|++++++++|Yes|KMS 和 TDE

### 许可
* Amazon RDS Oracle和Microsoft SQL Server是商业软件产品，需要适当的许可证才能在云中运行。AWS提供两种许可模式：包括许可证和自带许可证（BYOL）。

* **许可包含**  在许可包含模型中，该许可由AWS持有，并包含在Amazon RDS实例价格中。对于Oracle，包含的许可证为标准版1提供了许可。对于SQL Server，包含的许可证提供了对SQL Server速成版、Web版和标准版的许可。

* **带上你自己的许可证（BYOL）**  在BYOL模型中，你提供你自己的许可证。对于Oracle，您必须具有要运行的DB实例类和Oracle数据库版本的相应Oracle数据库许可证。您可以带来标准版1、标准版和企业版。

* 对于SQL Server，您可以在Microsoft许可证移动程序下提供自己的许可证。您可以使用Microsoft SQL标准版和企业版。您负责跟踪和管理如何分配许可证。

### Amazon Aurora
* Amazon Aurora提供企业级商业数据库技术，同时提供开源数据库的简单性和成本效益。这是通过重新设计MySQL的内部组件以采用更面向服务的方法来实现的。

* 与其他Amazon RDS引擎一样，Amazon Aurora是一个完全托管的服务，与MySQL兼容，提供比标准MySQL部署更高的可靠性和性能。Amazon极光可以提供MySQL性能的五倍，而不需要对大多数现有Web应用程序进行更改。您可以使用与Amazon Auroor现有MySQL数据库一起使用的相同代码、工具和应用程序。

* 当您第一次创建Amazon Aurora实例时，您将创建一个DB集群。DB集群有一个或多个实例，并且包含一个管理这些实例的数据的集群卷。Amazon Aurora群集卷是一个虚拟数据库存储卷，它跨越多个可用性区域，每个可用性区域都有群集数据的副本。Amazon Aurora DB集群由两种不同类型的实例组成：

* **Primary Instance** 这是主实例，它同时支持读写工作负载。当您修改数据时，您正在修改主实例。每个Amazon Aurora DB集群都有一个主实例

* **Amazon Aurora Replica** 这是一个只支持读操作的辅助实例。除了主实例之外，每个DB集群最多可以有15个Amazon Aurora副本。通过使用多个Amazon Aurora副本，您可以将读取工作负载分布在不同的实例中，从而提高性能。您还可以在多个可用性区域中定位Amazon Aurora副本，以提高数据库可用性。

### 存储选项
* Amazon RDS是使用Amazon Elastic Block Store（Amazon EBS）构建的，允许您根据性能和成本要求选择正确的存储选项。根据数据库引擎和工作负载的不同，您可以在已配置的存储中扩展到4到6TB，最高可以扩展到30000 IOPS。Amazon RDS支持三种存储类型：磁性、通用（固态驱动器[SSD]）和配置的IOPS（SSD）。表7.5突出显示了类型之间的相对大小、性能和成本差异。

表7.5 Amazon RDS 存储类型
 |磁性|通用（SSD）|配置的IOPS（SSD）
 ---|---|---|---
 size|+++|+++++|+++++
 性能|+|+++|+++++
 成本|++|+++|+++++

* **磁性** 磁性存储也被叫作标准存储，提供经济高效的存储，非常适合I/O要求较低的应用
* **通用（SSD）**通用（SSD）备份存储，也称为gp2，可以提供比磁存储更快的访问速度。这种存储类型可以提供突发性能，以满足峰值，是优秀的中小型数据库。

* **Provisioned IOPS（SSD）** Provisioned  IOPS（SSD）存储是为满足I/O密集型工作负载（特别是数据库工作负载）的需要而设计的，这些工作负载对存储性能和随机访问I/O吞吐量的一致性非常敏感。

* 备注

对于大部分的应用来说，通用（SSD）是最好的选择，它提供了低成本和高性能特性的良好组合

### 备份和恢复
* Amazon RDS为跨不同数据库引擎的备份和恢复过程提供了一致的操作模型。Amazon RDS提供了两种备份数据库的机制：自动备份和手动快照。通过结合使用这两种技术，可以设计备份恢复模型来保护应用程序数据。

* 每个组织通常会根据应用程序的关键性和用户的期望，为重要应用程序定义恢复点目标（RPO）和恢复时间目标（RTO）。企业系统通常有一个在分钟内测量的RPO和在小时或甚至几天内测量的RTO，而一些关键应用可能具有更低的容忍度。

* RPO被定义为在故障或事件发生时可接受的数据丢失的最大周期。例如，许多系统每15分钟备份一次事务日志，以便在意外删除或硬件故障时将数据丢失降至最低。

* RTO被定义为允许从备份中恢复并恢复处理的最大停机时间。特别是对于大型数据库，从完整备份还原可能需要几个小时。如果发生硬件故障，可以通过故障转移到辅助节点将RTO减少到几分钟。您应该创建一个恢复计划，该计划至少允许您从最近的备份中恢复。

#### 自动备份

* 自动备份是Amazon RDS的一个特性，它可以持续跟踪更改并备份数据库。Amazon RDS会创建数据库实例的存储卷快照，备份整个数据库实例，而不仅仅是单个数据库。可以在创建数据库实例时设置备份保留期。默认情况下将保留一天的备份，但您可以将保留期修改为最多35天。请记住，删除数据库实例时，会删除所有自动备份快照，并且无法恢复。但是，不会删除手动快照。

* 在可配置的30分钟维护窗口（称为备份窗口）中，每天都会进行自动备份。自动备份保留可配置的天数，称为备份保留期。在此保留期内，可以将数据库实例还原到任何特定时间，从而创建新的数据库实例。



#### 手工DB快照

* 除了自动备份之外，您还可以随时执行手动数据库快照。数据库快照由您启动，可以根据需要频繁创建。然后可以随时将数据库实例还原到数据库快照中的特定状态。可以使用Amazon RDS控制台或CreateDBSnapshot操作创建DB快照。与在保留期之后删除的自动快照不同，手动数据库快照将一直保留，直到使用Amazon RDS控制台或DeleteDBSnapshot操作显式删除它们

* 备注

对于繁忙的数据库，使用Multi-AZ将快照的性能影响降到最低。在备份窗口期间，在备份数据时，存储I/O可能会挂起，并且您可能会遇到延迟增加的情况。此I/O挂起通常持续快照期间。对于多AZ DB部署，这段I/O暂停时间更短，因为备份是从备用数据库获取的，但备份过程中可能会出现延迟。


#### 恢复

* 无论是执行自动备份还是手动数据库快照，Amazon RDS都允许您快速恢复数据库。无法从DB快照恢复到现有的DB实例；在还原时创建新的DB实例。还原数据库实例时，只有默认的数据库参数和安全组与restoredinstance关联。一旦还原完成，您就应该将从中还原的实例使用的任何自定义数据库参数或安全组关联起来。使用自动备份时，Amazon RDS将在预定义维护窗口期间执行的每日备份与事务日志结合起来，使您能够将DB实例还原到保留期内的任何点，通常恢复到最后5分钟。

### 多AZ高可用

* Amazon RDS最强大的特性之一是多AZ部署，它允许您跨多个可用性区域创建数据库集群。建立一个以高可用性和容错方式运行的关系数据库是一项具有挑战性的任务。使用Amazon RDS多AZ，您可以减少与此常见管理任务相关的复杂性；使用单个选项，Amazon RDS可以使用复制增加数据库的可用性。Multi-AZ使您能够通过使用同步复制来最小化RPO，并通过快速故障切换将RTO最小化到几分钟，从而满足最苛刻的RPO和RTO目标。

* Multi-AZ允许您将数据库的辅助副本放置在另一个可用性区域中，以便进行灾难恢复。多AZ部署可用于所有类型的Amazon RDS数据库引擎。创建多AZ DB实例时，在一个可用性区域中创建主实例，在另一个可用性区域中创建辅助实例。您被分配了一个数据库实例终结点，如下所示：

my_app_db.ch6fe7ykq1zd.us-west-2.rds.amazonaws.com

* 此终结点是一个域名系统（DNS）名称，AWS负责解析为特定IP地址。创建到数据库的连接时使用此DNS名称。图7.1展示了跨越两个可用性区域的典型多AZ部署。

图7.1 度AZ Amazon RDS架构

* Amazon RDS使用同步复制将数据从主数据库或主实例自动复制到从数据库或辅助实例。每个可用性区域都运行在其物理上不同的、独立的基础设施上，并且设计为高度可靠。Amazon RDS会检测并自动从多AZ部署的最常见故障场景中恢复，这样您就可以在没有管理干预的情况下尽快恢复数据库操作。如果发生以下任一情况，Amazon RDS将自动执行故障转移：
```
 * 主可用区中的可用性丢失
 * 与主数据库的网络连接丢失
 * 主数据库计算单元故障
 * 主数据库存储故障
```

* Amazon RDS将自动故障转移到备用实例，无需用户干预。DNS名称保持不变，但Amazon RDS服务将CNAME更改为指向备用服务器。如果出现可用性区域服务中断、主数据库实例失败或实例类型更改，则主数据库实例将自动切换到备用副本。您还可以对数据库实例执行手动故障转移。主实例和辅助实例之间的故障转移速度很快，自动故障转移完成所需的时间通常为一到两分钟。

* 备注

重要的是要记住，多AZ部署仅用于灾难恢复；它们不是用来提高数据库性能的。备用数据库实例不可用于来自主主数据库实例的脱机查询。要使用多个数据库实例提高数据库性能，请使用读取副本或其他数据库缓存技术

### 扩缩容
* 随着事务数量增加到一个关系数据库中，通过获得一个更大的机器，可以放大或垂直地处理更多的读写操作。横向或横向扩展也是可能的，但通常更困难。Amazon RDS允许您垂直缩放计算机和存储，对于某些DB引擎，您可以水平缩放。

### 垂直扩展
* 向数据库中添加额外的计算、内存或存储资源可以处理更多事务、运行更多查询和存储更多数据。Amazon RDS可以方便地向上或向下扩展数据库层，以满足应用程序的需求。更改扫描计划在下一个维护窗口期间进行，或立即开始使用ModifyDBInstance操作。

* 若要更改计算量和内存量，可以选择数据库的其他数据库实例类。选择一个较大或较小的DB实例类后，Amazon RDS会自动将迁移过程迁移到一个新类，只需很短的中断时间和最少的工作量。

* 您还可以增加Amazon RDS实例的存储量、存储类和存储性能。根据存储类型和引擎的不同，每个数据库实例在提供的存储中可以从5GB扩展到6TB。随着需求的增长，Amazon RDS的存储可以随着时间的推移而增加，对运行中的数据库的影响最小。除SQL Server外，所有数据库引擎都支持Storageexpansion。

#### 具有分区的水平可伸缩性
* 关系数据库只能在达到最大化大小之前垂直缩放。将大型关系数据库划分为多个实例或碎片是一种常见的技术，用于处理超出单个实例能力范围的更多请求。分区或碎片化允许您水平扩展以处理更多用户，而请求需要应用程序层中的附加逻辑。应用程序需要决定如何将数据库请求路由到正确的shard，并在可以跨服务器边界执行的查询类型上受到限制。像Amazon DynamoDB或assandra这样的NoSQL数据库被设计成水平扩展。

#### 具有读取副本的水平可扩展性
* 另一个重要的扩展技术是使用读取副本从主数据库卸载读取事务并增加事务的总数。Amazon RDS支持read replicas，它允许您在读取繁重的数据库工作负载时，灵活地扩展到超出单个DB实例的容量限制的范围。

* 有多种使用情况下，部署一个或多个读取副本DB实例是安全的。一些常见的场景包括：
```
  * 扩展到超出单个数据库实例的容量，以便读取繁重的工作负载。
  * 在源数据库实例不可用时处理读取流量。例如，由于备份或计划维护的I/O开销，您可以将读取流量定向到副本。
  * 针对副本而不是primaryDB实例卸载报告或数据仓库方案。
```

* 例如，博客网站可能只有很少的写活动，除了occasionalcomment和绝大多数数据库活动将是只读的。通过将一些或所有读活动卸载到一个或多个读副本，主数据库实例可以集中处理写操作并将数据复制到副本中。

* Amazon RDS for MySQL、PostgreSQL、MariaDB和Mazon Aurora当前支持读副本。Amazon RDS使用MySQL、MariaDB和PostgreSQL DB引擎的内置复制功能，从源DB实例创建一个特殊类型的DB实例，称为读取副本。对源数据库实例所做的更新将异步复制到读取副本。通过将应用程序中的读取查询路由到读取副本，可以减少源数据库实例上的负载。

* 备注

可以在单个AWS区域内或跨多个AWS区域创建数据库的一个或多个副本。为了增强灾难恢复能力或减少全局延迟，可以使用跨区域读取副本为从较近的区域到全局用户的读取流量提供服务，或者跨AWS区域迁移数据库。

### 安全
* 保护Amazon RDS DB实例和关系数据库的安全需要一个全面的eplan，它可以解决数据库驱动系统中常见的许多层。这包括基础设施资源、数据库和网络。

* 使用限制AWS管理员可以执行哪些操作的AWS标识和访问管理（IAM）策略保护对基础设施资源的访问。例如，可以在IAM中控制的一些密钥管理员操作包括CreateDBInstance和deletedbinstance。

* 另一个安全最佳实践是将Amazon RDS DB实例部署到Amazon虚拟私有云（Amazon VPC）中的私有子网中，该子网限制对DB实例的网络访问。在部署到Amazon VPC之前，必须首先创建一个DBsubnet组，该组预先定义哪些子网可用于Amazon RDS部署。此外，使用网络访问控制列表（acl）和安全组限制网络访问，以将入站流量限制为源IP地址的短列表。

* 在数据库级别，您还需要创建用户并授予他们对数据库的读写权限。对数据库的访问是通过数据库技术特别是访问控制和用户管理机制来控制的。使用频繁轮换的强密码在数据库级别创建用户。

* 最后，使用Amazon RDS提供的多种加密功能保护传输和静止数据的机密性。不同引擎的安全特性略有不同，但所有引擎都支持某种形式的传输中加密以及rest加密。您可以使用Secure SocketsLayer（SSL）将客户机安全地连接到正在运行的DB实例，以保护传输中的数据。所有使用mazon密钥管理服务（KMS）或透明数据加密（TDE）的引擎都可以使用静态加密。对于加密的Amazon RDS实例，所有日志、备份和快照都是加密的。

## Amazon Redshift
* Amazon Redshift是一个快速、强大、完全管理、PB级的云数据仓库服务。amazonredshift是一个关系数据库，专为OLAP场景设计，并针对超大数据集的高性能分析和报告进行了优化。传统的数据仓库管理困难且成本高昂，尤其是对于大型数据集。Amazon Redshift不仅显著降低了数据仓库的成本，而且还可以方便地快速分析大量数据。

* AmazonRedshift使用标准的sqlcommand支持对大型数据集的交互式查询，为您提供了对结构化数据的快速查询功能。通过ODBC或jdbc连接，Amazon Redshift可以很好地与各种数据加载、报告、数据挖掘和分析工具集成。Amazon Re红移是基于行业标准PostgreSQL的，因此大多数现存的SQL客户端应用程序将只使用最小的更改。

* Amazon RealSHIFT管理建立、操作和缩放数据仓库所需的工作，从提供基础设施能力到自动化正在进行的管理任务（如备份和补丁）。Amazon Redshift会自动监视您的节点和驱动器，帮助您从故障中恢复

### 集群和节点
* Amazon Redshift数据仓库的关键组件是集群。集群由一个管理节点和一个或多个计算节点组成。客户机应用程序与管理节点直接交互，计算节点对外部应用程序透明。Amazon Redshift目前支持六种不同的节点类型，每个节点都有不同的CPU、内存和存储空间。这六种节点类型分为两类：计算密集型和存储密集型。密集计算节点类型支持高达326TBusing fast ssd的集群，而密集存储节点支持高达2PB的使用大磁盘的集群。每个集群由一个引导节点和一个或多个计算节点组成。图7.2显示了Amazon Redshift数据仓库集群的内部组件。

* 图7.2 Amazon Redshift 集群架构

* 每个集群包含一个或多个数据库。每个表的用户数据分布在计算节点上。您的应用程序或SQL客户机使用标准JDBC或ODBC连接与leader节点与Amazon Redshift通信，后者反过来协调queryexecution和compute节点。您的应用程序不与计算节点直接交互。

* 计算节点的磁盘存储被分成若干片。切片器节点的数量取决于群集的节点大小，通常在2到16之间变化。所有节点都参与并行查询执行，处理尽可能均匀地分布在各个切片上的数据。

* 可以通过向群集添加多个节点来提高查询性能。提交查询时，Amazon Redshift会在acluster的所有计算节点上并行分布和执行查询。Amazon Redshift还基于您指定的分发策略将表数据分散到集群中的所有计算节点上。这种跨多个计算资源的数据分区允许您获得高级别的性能。

* Amazon Redshift允许您调整集群的大小，以便随着时间的推移添加存储和计算容量。您还可以更改集群的节点类型并保持总体大小不变。每当执行调整大小操作时，Amazon Redshift将创建一个新集群，并将数据从旧集群迁移到新集群。在调整大小操作期间，数据库将变为只读，直到操作完成。

### 表设计
* 每个Amazon Redshift集群可以支持一个或多个数据库，每个数据库可以包含多个表。与大多数基于SQL的数据库一样，可以使用create table命令创建表。此命令指定表的名称、列及其数据类型。除了列和数据类型之外，Amazon Redshift CREATE TABLE命令还支持指定压缩编码、分发策略和排序键。

### 数据类型
* Amazon Redshift列支持多种数据类型。这包括常见的数字数据类型，如INTEGER、DECIMAL和DOUBLE，文本数据类型，如CHAR和varchar，日期数据类型，如date和TIMESTAMP。可以使用ALTALTABLE命令将附加列添加到表中；但是，现有列不能被修改

### 编码压缩
* Amazon Redshift使用的关键性能优化之一是数据压缩。当第一次将数据加载到空表中时，Amazon Redshift将自动对数据进行采样，并为每个列选择最佳的压缩方案。或者，可以在createtable命令中指定每列的压缩编码。

### 分布式策略
* 在Amazon Redshift中创建表时，主要的决定之一是如何跨集群中的节点和片分发记录。您可以配置表的分发样式，以向Amazon Redshift提供有关如何将数据分区为最符合您的查询模式的提示。当您运行查询时，优化器会根据需要将行移到computenodes以执行任何联接和聚合。选择tabledistribution样式的目的是通过在执行查询之前将数据放在需要的位置来最小化重新分发步骤的影响。

* 为数据库选择的数据分发样式对查询性能、存储要求、数据加载和维护有很大影响。通过为每个表选择最佳分布策略，可以平衡数据分布，显著提高系统的整体性能。创建表时，可以在三种分布样式中选择一种：偶数、键或全部。

* 偶数分布这是默认选项，会导致数据以统一的方式分布在各个切片上，而不管数据是什么。
* 键分布时，行根据一列中的值分布。leader节点将把匹配的值存储在一起，并增加joins的查询性能。
* ALL distribution，使用ALL，整个表的完整副本将分发给每个节点。这对于查找表和其他不经常更新的大表很有用

### sort Keys
* 在创建表期间要做的另一个重要决定是指定一个或多个列作为排序键。排序可以有效地处理范围受限谓词。如果查询使用范围限制谓词，查询处理器可以在表扫描期间快速跳过大量块。

* 表的排序键可以是复合键，也可以是交错键。当查询谓词使用前缀时，复合排序键的效率更高，前缀是排序键列inorder的子集。交错排序键为排序键中的每一列赋予相等的权重，因此querypredicates可以按任何顺序使用组成排序键的列的任何子集。

### Loading Data

* Amazon Redshift支持标准的SQL命令，比如INSERT和UPDATE来创建和修改表中的记录。但是，对于批量操作，Amazon Redshift提供copy命令作为比重复调用INSERT更有效的替代方法。

* 备注

COPY命令可以以最有效的方式将数据加载到表中，并且它支持多种类型的输入数据源。将数据加载到AmazonRedshift的最快方法是从存储在Amazon Simple StorageService（Amazon S3）bucket中的平面文件或amazondymodb表中进行批量数据加载。

* 从Amazon S3加载数据时，COPY命令可以同时读取多个文件。Amazon Redshift可以将工作负载分配给节点并并行执行加载过程。您可以使用一个包含多个节点和多个输入文件的群集来启用并行处理，而不是使用一个包含数据的大文件。

* 每次大容量数据加载后，如果修改了大量数据，则需要执行VACUUM命令来重新组织数据并在删除后回收空间。还建议运行ANALYZE命令来更新表统计信息。

* 还可以使用UNLOAD命令从Amazon Redshift中导出数据。此命令可用于生成分隔文本文件并将其存储在Amazon S3中

### Querying Data
* Amazon Redshift允许您编写标准SQL命令来查询表。通过支持SELECT等命令来查询和连接表，分析师可以使用Amazon Redshift快速提高工作效率，或者轻松地集成它。对于复杂的查询，可以分析查询计划以更好地优化访问模式。您可以使用Amazon CloudWatch和Amazon Redshift webconsole监视集群和特定查询的性能。

* 对于支持许多用户的大型Amazon Redshift集群，您可以配置WorkloadManagement（WLM）来对查询进行排队和排序。WLM允许您定义多个队列并为每个队列设置并发级别。例如，您可能希望为长时间运行的查询设置一个队列，并限制并发性，为短时间运行的查询设置另一个队列，并允许更高级别的并发性

### 快照
* 与Amazon RDS类似，您可以创建Amazon Redshiftcluster的时间点快照。然后，可以使用快照还原原始lamazon Redshift集群的副本或创建其克隆。Amazon Redshift将快照持久地存储在Amazon S3中。

* AmazonRedshift支持自动快照和手动快照。使用自动快照，Amazon Redshift将定期为集群拍摄快照，并在可配置的保留期内保留一个副本。您还可以执行手动快照，并跨区域或甚至与其他AWS帐户共享它们。手动快照将被保留，直到您显式删除它们。


### 安全
* 保护Amazon Redshift集群与保护云中运行的其他数据库类似。安全计划应包括保护基础结构资源、数据库架构、表中记录和网络访问的控件。通过解决everylevel的安全问题，您可以在云中安全地操作Amazon Redshift数据仓库。

* 第一层安全是在基础设施级别，使用IAM策略限制AWS管理员可以执行的操作。使用IAM，您可以创建策略，授予其他AWS用户创建和管理群集生命周期的权限，包括扩展、备份和恢复操作。

* 在网络级别，可以在Amazon VPC的专用IP地址空间内部署Amazon Redshift群集，以限制整个网络连接。使用子网级别的安全组和网络ACL可以进一步限制细粒度网络访问。

* 除了在基础结构级别控制基础结构访问外，还必须在数据库级别保护访问。最初创建Amazon Redshift集群时，将创建主用户帐户和密码。主帐户可用于登录mazon Redshift数据库并创建更多用户和组。每个数据库用户都可以获得对架构、表和其他数据库对象的权限。这些权限独立于用于控制对基础结构资源的访问和Amazon Redshift群集配置的IAM策略。

* 保护存储在Amazon Redshift中的数据是安全设计的另一个重要方面。Amazon Redshift支持使用SSL加密连接对传输中的数据进行加密，还支持使用多种技术对静止数据进行加密。为了加密数据atrest，Amazon Redshift与KMS和AWS CloudHSM集成，提供加密密钥管理服务。静止和传输中的加密有助于满足合规性要求，如健康保险便携性和责任法案（HIPAA）或支付卡行业数据安全标准（PCI DSS），并为您的数据提供额外的保护

## Amazon DynamoDB

* Amazon DynamoDB是一个完全托管的NoSQL数据库服务，它提供快速和低级别的性能，可以轻松地扩展。Amazon DynamoDB 允许您减轻操作分布式NoSQL数据库的管理负担，并专注于应用程序。Amazon DynamoDB显著简化了NoSQL数据库的硬件配置、设置和配置、复制、软件修补和集群扩展。

* Amazon DynamoDB旨在简化数据库和集群管理，提供不一致的高性能，简化可扩展任务，并通过自动复制。开发人员可以在Amazon DynamoDB中创建一个表，并以一致的延迟编写一个数量有限的项。

* Amazon DynamoDB可以通过在多个分区上自动分配表的数据和流量来提供一致的性能级别。在您配置了一定的读写容量之后，Amazon DynamoDB将自动添加足够的基础设施容量来支持请求的吞吐量级别。随着时间的推移，您可以在创建表后调整读写容量，Amazon DynamoDB将添加或删除基础设施并相应地调整内部分区。

* 为了帮助保持一致、快速的性能级别，所有表数据都存储在高性能的固态硬盘驱动器上。可以使用Amazon CloudWatch监视性能指标，包括事务速率。除了提供高性能级别之外，Amazon DynamoDB还通过在AWS区域内跨多个可用性区域应用数据，提供自动高可用性和持久性保护。

### 数据模型
* Amazon DynamoDB数据模型包含如下基本组件：
```
 * 表（tables）
 * 项（items）
 * 属性（attributes）
```
* 如图7.3所示，表由items构成，item由一个或者更多的属性构成。每个item有一个唯一标识item的主key。

* 在关系数据库中，表具有预定义的架构，如表名、主键、列名列表及其数据类型。表中存储的所有记录必须具有相同的列集。相反，Amazon DynamoDB只要求一个表具有一个primary键，但它不要求您事先定义所有的属性名和数据类型。Amazon DynamoDB表中的单个项目可以有任意数量的属性，尽管项目大小有400KB的限制。

* 项目中的每个属性都是一个名称/值对。属性可以是单值或多值集。例如，图书项可以具有title和authors属性。每本书只有一个标题，但可以有许多作者。多值属性是一个集合；不允许重复值。数据以键/值对的形式存储在Amazon DynamoDB中，如下所示：
```
 {
    Id = 101
    ProductName = "Book 101 Title"
    ISBN = "123–1234567890"
    Authors = [ "Author 1", "Author 2" ]
    Price = 2.88
    Dimensions = "8.5 x 11.0 x 0.5"
    PageCount = 500
    InPublication = 1
    ProductCategory = "Book"
 }
```
* 应用程序可以连接到Amazon DynamoDB服务端点，并通过HTTP/S提交请求来读写表项，甚至可以创建和删除表。DynamoDB提供一个web服务API，它接受JSON格式的请求。虽然可以直接针对web服务API端点进行编程，但大多数开发人员选择使用AWS 软件开发工具包（SDK）与他们的项和表进行交互。AWS SDK可以用多种语言提供，并提供了一个简化的高级编程接口


### 数据类型
* Amazon DynDoDB为数据库架构提供了很多灵活性。与传统关系数据库要求您提前定义列类型不同，DynamoDB只需要主键属性。添加到表中的每个项都可以添加其他属性。随着时间的推移，您可以灵活地扩展整个架构，而不必重新构建整个表并处理应用程序逻辑的记录版本差异。

* 当创建表或辅助索引时，必须指定每个主键属性（分区键和排序键）的名称和数据类型。Amazon DynamoDB支持多种属性数据类型。数据类型分为三大类：标量、集合、文档

**标量数据类型** 标量类型只表示一个值。Amazon DynamoDB支持以下五种标量类型：
```
 * String: 长度可达400KB字符的文本和变量。支持utf8编码的unicode
 * Number：38位精度的正数或者负数
 * Binary：二进制数据，图片，压缩对象，最大：400KB
 * Boolean：二进制标记，true或者false
 * Null：代表blank，empty或者unknown状态。

 备注：String，Number,Binary,Boolean 不能为empty。

```

**Set数据类型** 集合用于表示一个或多个标量值的唯一列表。集合中的每个值必须是唯一的，并且必须是相同的数据类型。集合不能保证顺序。Amazon DynDoDB支持三种集合类型：字符串集合、数字集合和二进制集合。 
```
 * String set: String 属性的唯一列表
 * Number set：Number 属性的唯一列表
 * Binary set： Binary属性的唯一列表
```

**Document数据类型** 文档类型用于表示多个嵌套属性，类似于JSON文件的结构。Amazon DynDoDB支持两种文档类型：List和Map。可以组合和嵌套多个列表和映射以创建复杂结构。
```
 List：每个list可以存放不同数据类型的属性的有序列表。
 Map：每个映射可用于存储键/值对的无序列表。映射可用于表示任何JSON对象的结构。

```







## 总结
* 在本章中，您学习了关系数据库、数据仓库和nosql数据库的基本概念。

* 您还了解了AWS 托管的数据库服务Amazon RDS、Amazon Redshift的优点和特性，和Amazon DynamoDB。

* Amazon RDS管理管理数据库基础结构和软件所涉及的繁重工作，并允许您专注于构建最适合您的使用案例的关系模式和优化查询的性能调整。

* Amazon RDS支持流行的开源和商用数据库引擎，并提供通用管理任务的一致操作模型。

* 通过使用多AZ部署跨可用性区域运行主从配置来提高可用性。

* 使用读取副本扩展应用程序并提高数据库读取性能。

* Amazon Redshift允许您在几分钟内部署针对分析和报告工作负载进行优化的数据仓库群集。

* Amazon Redshift使用列存储来分发记录，并跨多个计算节点并行执行查询，以提供快速的查询性能。

* Amazon Redshift集群可以放大或缩小以支持大型，使用固态硬盘或磁盘存储的PB级数据库。

* 使用JDBC/ODBC驱动程序的标准SQL客户端连接到Amazon Redshift群集，并使用许多与您现在使用的相同的分析和ETL工具执行SQL查询。

* 使用COPY命令将数据加载到Amazon Redshift群集，以大容量导入存储在Amazon S3中的flatfiles，然后运行标准的SELECT命令来搜索和查询表。

* 使用自动和手动快照备份Amazon RDS数据库和Amazon Redshift集群，以允许时间点恢复。

* 使用IAM、数据库级访问控制、网络级访问控制和数据加密技术的组合来保护Amazon RDS和Mazon Redshift数据库的安全。
* Amazon DynamoDB简化了云中NoSQL数据库的管理和操作。

* Amazon DynamoDB允许您快速创建可以扩展到无限数量的项目并配置非常高的提供的读写能力的级别。

* Amazon DynamoDB表提供了一种灵活的数据存储机制，只需要一个简单的密钥并允许一个或多个属性。

* Amazon DynamoDB既支持simplescaler数据类型，如String和Number，也支持使用List和map的更复杂的结构。

* 使用IAM保护您的Amazon DynamoDB表，并使用细粒度访问控制限制对项和属性的访问。

* Amazon DynamoDB将处理群集和分区管理的困难任务，并为您提供一个高度可用的数据库表，该表可跨可用性区域复制数据，以提高耐用性。

* 利用Amazon DynamoDB流跟踪和处理最近的变化

## 







































## 练习


## 复习题




























